<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Netty writeAndFlush解析 | 永远滴神</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="shortcut icon" href="/favicon.ico" type="iamge/x-icon">
    <meta name="description" content="一个用心帮助你成长的公众号">
    <meta name="keywords" content="永远滴神 后端 公众号">
    
    <link rel="preload" href="/assets/css/0.styles.82a4f3fa.css" as="style"><link rel="preload" href="/assets/js/app.c279a524.js" as="script"><link rel="preload" href="/assets/js/2.0c1afcb6.js" as="script"><link rel="preload" href="/assets/js/9.b79e982a.js" as="script"><link rel="preload" href="/assets/js/7.84ef9767.js" as="script"><link rel="preload" href="/assets/js/12.f1c48cfc.js" as="script"><link rel="preload" href="/assets/js/13.70bd7ce1.js" as="script"><link rel="prefetch" href="/assets/js/10.e26101b4.js"><link rel="prefetch" href="/assets/js/11.9f39b567.js"><link rel="prefetch" href="/assets/js/14.2b6f6c3d.js"><link rel="prefetch" href="/assets/js/15.a79a89f0.js"><link rel="prefetch" href="/assets/js/16.4b42d084.js"><link rel="prefetch" href="/assets/js/17.a9cce4ad.js"><link rel="prefetch" href="/assets/js/18.fbbc06c5.js"><link rel="prefetch" href="/assets/js/19.a05e6a7c.js"><link rel="prefetch" href="/assets/js/20.9a58f68f.js"><link rel="prefetch" href="/assets/js/21.a2a6463a.js"><link rel="prefetch" href="/assets/js/22.8214d8b2.js"><link rel="prefetch" href="/assets/js/23.8cbb570e.js"><link rel="prefetch" href="/assets/js/24.48aa175f.js"><link rel="prefetch" href="/assets/js/25.84608df8.js"><link rel="prefetch" href="/assets/js/26.305db893.js"><link rel="prefetch" href="/assets/js/27.206035f7.js"><link rel="prefetch" href="/assets/js/28.67715c64.js"><link rel="prefetch" href="/assets/js/29.14071b9d.js"><link rel="prefetch" href="/assets/js/3.31bcfe44.js"><link rel="prefetch" href="/assets/js/30.dc0684e5.js"><link rel="prefetch" href="/assets/js/31.883ad823.js"><link rel="prefetch" href="/assets/js/32.ecf2894d.js"><link rel="prefetch" href="/assets/js/33.aff8d5e4.js"><link rel="prefetch" href="/assets/js/34.be686b6a.js"><link rel="prefetch" href="/assets/js/35.c0cb3ba1.js"><link rel="prefetch" href="/assets/js/36.a002f118.js"><link rel="prefetch" href="/assets/js/37.e76eaea2.js"><link rel="prefetch" href="/assets/js/38.b4604ac1.js"><link rel="prefetch" href="/assets/js/39.763c67c0.js"><link rel="prefetch" href="/assets/js/4.d0009a91.js"><link rel="prefetch" href="/assets/js/40.b9fd76a7.js"><link rel="prefetch" href="/assets/js/41.a42f44ff.js"><link rel="prefetch" href="/assets/js/42.b52500a4.js"><link rel="prefetch" href="/assets/js/43.eb1e5211.js"><link rel="prefetch" href="/assets/js/44.2cb493cd.js"><link rel="prefetch" href="/assets/js/45.d7f0976e.js"><link rel="prefetch" href="/assets/js/46.7ffb8b39.js"><link rel="prefetch" href="/assets/js/47.2967a68c.js"><link rel="prefetch" href="/assets/js/48.35389a81.js"><link rel="prefetch" href="/assets/js/49.0d17f7bc.js"><link rel="prefetch" href="/assets/js/5.c42b1e5e.js"><link rel="prefetch" href="/assets/js/50.9ca014f6.js"><link rel="prefetch" href="/assets/js/51.5956567e.js"><link rel="prefetch" href="/assets/js/52.6da5773a.js"><link rel="prefetch" href="/assets/js/53.030556f0.js"><link rel="prefetch" href="/assets/js/54.e54a1605.js"><link rel="prefetch" href="/assets/js/55.0f443484.js"><link rel="prefetch" href="/assets/js/56.b77dce48.js"><link rel="prefetch" href="/assets/js/57.e8803295.js"><link rel="prefetch" href="/assets/js/58.eeb1ac26.js"><link rel="prefetch" href="/assets/js/59.0b9b5c35.js"><link rel="prefetch" href="/assets/js/6.c54a32fc.js"><link rel="prefetch" href="/assets/js/60.f3b0cf20.js"><link rel="prefetch" href="/assets/js/61.b2b65094.js"><link rel="prefetch" href="/assets/js/62.b5df885c.js"><link rel="prefetch" href="/assets/js/63.029e4e19.js"><link rel="prefetch" href="/assets/js/64.c96e2154.js"><link rel="prefetch" href="/assets/js/65.9de74a66.js"><link rel="prefetch" href="/assets/js/66.194ed1ac.js"><link rel="prefetch" href="/assets/js/67.7d6aae93.js"><link rel="prefetch" href="/assets/js/68.469ec24a.js"><link rel="prefetch" href="/assets/js/69.66f2fcf5.js"><link rel="prefetch" href="/assets/js/70.876f0081.js"><link rel="prefetch" href="/assets/js/71.f7f93b2e.js"><link rel="prefetch" href="/assets/js/72.ba2032df.js"><link rel="prefetch" href="/assets/js/73.82cdb3d0.js"><link rel="prefetch" href="/assets/js/74.13d1084f.js"><link rel="prefetch" href="/assets/js/75.2e4b95b9.js"><link rel="prefetch" href="/assets/js/76.c3c1eaba.js"><link rel="prefetch" href="/assets/js/77.5674dbce.js"><link rel="prefetch" href="/assets/js/78.6b1fb7a6.js"><link rel="prefetch" href="/assets/js/79.5920b2ff.js"><link rel="prefetch" href="/assets/js/8.1bdaa967.js"><link rel="prefetch" href="/assets/js/80.cb244441.js"><link rel="prefetch" href="/assets/js/81.f6440a0e.js"><link rel="prefetch" href="/assets/js/82.0ec434bf.js"><link rel="prefetch" href="/assets/js/83.f3186073.js">
    <link rel="stylesheet" href="/assets/css/0.styles.82a4f3fa.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/home.png" alt="永远滴神" class="logo"> <span class="site-name can-hide">永远滴神</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/node/" class="nav-link">node</a></div><div class="nav-item"><a href="/netty/" class="nav-link router-link-active">netty</a></div><div class="nav-item"><a href="/database/" class="nav-link">数据库</a></div><div class="nav-item"><a href="/interview/" class="nav-link">面试问题</a></div><div class="nav-item"><a href="https://github.com/koala-coding/FE-Infer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  招聘●内推
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/about/2019_year_end.html" class="nav-link">关于我</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/node/" class="nav-link">node</a></div><div class="nav-item"><a href="/netty/" class="nav-link router-link-active">netty</a></div><div class="nav-item"><a href="/database/" class="nav-link">数据库</a></div><div class="nav-item"><a href="/interview/" class="nav-link">面试问题</a></div><div class="nav-item"><a href="https://github.com/koala-coding/FE-Infer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  招聘●内推
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/about/2019_year_end.html" class="nav-link">关于我</a></div> <!----></nav> <div class="my_introduce" style="padding-left:1rem;"><div class="introduce_component" data-v-37981958><img src="/small.png" alt data-v-37981958> <div class="intro_content" data-v-37981958><h3 data-v-37981958>公众号:程序员成长指北</h3> <p data-v-37981958>koala 学习成长之路</p></div></div></div> <ul class="sidebar-links"><li><a href="/netty/io.html" class="sidebar-link">IO读写原理与IO模型</a></li><li><a href="/netty/netty_thread_mode.html" class="sidebar-link">Netty线程模型</a></li><li><a href="/netty/netty_server_start.html" class="sidebar-link">Netty服务端启动流程</a></li><li><a href="/netty/netty_task.html" class="sidebar-link">Netty IO事件与任务处理</a></li><li><a href="/netty/netty_memory.html" class="sidebar-link">Netty内存分配</a></li><li><a href="/netty/netty_write_and_flush.html" aria-current="page" class="active sidebar-link">Netty writeAndFlush解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/netty/netty_write_and_flush.html#概述" class="sidebar-link">概述</a></li><li class="sidebar-sub-header"><a href="/netty/netty_write_and_flush.html#事件传播机制" class="sidebar-link">事件传播机制</a></li><li class="sidebar-sub-header"><a href="/netty/netty_write_and_flush.html#netty缓冲区" class="sidebar-link">Netty缓冲区</a></li><li class="sidebar-sub-header"><a href="/netty/netty_write_and_flush.html#数据传输" class="sidebar-link">数据传输</a></li></ul></li><li><a href="/netty/netty_codec.html" class="sidebar-link">Netty编解码</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="netty-writeandflush解析"><a href="#netty-writeandflush解析" class="header-anchor">#</a> Netty writeAndFlush解析</h1> <h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <blockquote><p>Netty底层数据传输基于JDK NIO，调用writeAndFlush方法写出数据时，首先会通过编码器将Java对象编码为ByteBuf，然后会将ByteBuf转化为JDK NIO ByteBuffer，最后通过NioSocketChannel将数据写入到socket缓冲区。当socket缓冲区空间不足时会注册OP_WRITE事件，等到缓冲区的数据发送成功后有空闲空间时，会触发OP_WRITE事件，继续写出数据。</p></blockquote> <h2 id="事件传播机制"><a href="#事件传播机制" class="header-anchor">#</a> 事件传播机制</h2> <p>Netty事件分为入站事件与出站事件，可以通过ChannelPipline或者ChannelHandlerContext进行事件传播。通过ChannelPipline传播入站事件，它将被从ChannelPipeline的头部开始一直被传播到ChannelPipeline的尾端，出站事件则从尾端开始传递到头部。通过ChannelHandlerContext传播入站事件，它将被从下一个ChannelHandler开始直至传递到尾端，出站事件则从下一个ChannelHandler直至传递到头部。</p> <div class="language-java extra-class"><pre class="language-java"><code>                                                   <span class="token class-name">I</span><span class="token operator">/</span><span class="token class-name">O</span> <span class="token class-name">Request</span>
                                              via <span class="token class-name">Channel</span> or
                                          <span class="token class-name">ChannelHandlerContext</span>
                                                        <span class="token operator">|</span>
    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
    <span class="token operator">|</span>                           <span class="token class-name">ChannelPipeline</span>         <span class="token operator">|</span>               <span class="token operator">|</span>
    <span class="token operator">|</span>                                                  \<span class="token operator">|</span><span class="token operator">/</span>              <span class="token operator">|</span>
    <span class="token operator">|</span>    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>    <span class="token operator">|</span>
    <span class="token operator">|</span>    <span class="token operator">|</span> <span class="token class-name">Inbound</span> <span class="token class-name">Handler</span>  <span class="token class-name">N</span>  <span class="token operator">|</span>            <span class="token operator">|</span> <span class="token class-name">Outbound</span> <span class="token class-name">Handler</span>  <span class="token number">1</span>  <span class="token operator">|</span>    <span class="token operator">|</span>
    <span class="token operator">|</span>    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>    <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">/</span><span class="token operator">|</span>\                                  <span class="token operator">|</span>               <span class="token operator">|</span>
    <span class="token operator">|</span>               <span class="token operator">|</span>                                  \<span class="token operator">|</span><span class="token operator">/</span>              <span class="token operator">|</span>
    <span class="token operator">|</span>    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>    <span class="token operator">|</span>
    <span class="token operator">|</span>    <span class="token operator">|</span> <span class="token class-name">Inbound</span> <span class="token class-name">Handler</span> <span class="token class-name">N</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">|</span>            <span class="token operator">|</span> <span class="token class-name">Outbound</span> <span class="token class-name">Handler</span>  <span class="token number">2</span>  <span class="token operator">|</span>    <span class="token operator">|</span>
    <span class="token operator">|</span>    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>    <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">/</span><span class="token operator">|</span>\                                  <span class="token punctuation">.</span>               <span class="token operator">|</span>
    <span class="token operator">|</span>               <span class="token punctuation">.</span>                                   <span class="token punctuation">.</span>               <span class="token operator">|</span>
    <span class="token operator">|</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">fireIN_EVT</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">OUT_EVT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">|</span>
    <span class="token operator">|</span>        <span class="token punctuation">[</span> method call<span class="token punctuation">]</span>                       <span class="token punctuation">[</span>method call<span class="token punctuation">]</span>         <span class="token operator">|</span>
    <span class="token operator">|</span>               <span class="token punctuation">.</span>                                   <span class="token punctuation">.</span>               <span class="token operator">|</span>
    <span class="token operator">|</span>               <span class="token punctuation">.</span>                                  \<span class="token operator">|</span><span class="token operator">/</span>              <span class="token operator">|</span>
    <span class="token operator">|</span>    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>    <span class="token operator">|</span>
    <span class="token operator">|</span>    <span class="token operator">|</span> <span class="token class-name">Inbound</span> <span class="token class-name">Handler</span>  <span class="token number">2</span>  <span class="token operator">|</span>            <span class="token operator">|</span> <span class="token class-name">Outbound</span> <span class="token class-name">Handler</span> <span class="token class-name">M</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">|</span>    <span class="token operator">|</span>
    <span class="token operator">|</span>    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>    <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">/</span><span class="token operator">|</span>\                                  <span class="token operator">|</span>               <span class="token operator">|</span>
    <span class="token operator">|</span>               <span class="token operator">|</span>                                  \<span class="token operator">|</span><span class="token operator">/</span>              <span class="token operator">|</span>
    <span class="token operator">|</span>    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>    <span class="token operator">|</span>
    <span class="token operator">|</span>    <span class="token operator">|</span> <span class="token class-name">Inbound</span> <span class="token class-name">Handler</span>  <span class="token number">1</span>  <span class="token operator">|</span>            <span class="token operator">|</span> <span class="token class-name">Outbound</span> <span class="token class-name">Handler</span>  <span class="token class-name">M</span>  <span class="token operator">|</span>    <span class="token operator">|</span>
    <span class="token operator">|</span>    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>    <span class="token operator">|</span>
    <span class="token operator">|</span>              <span class="token operator">/</span><span class="token operator">|</span>\                                  <span class="token operator">|</span>               <span class="token operator">|</span>
    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
                    <span class="token operator">|</span>                                  \<span class="token operator">|</span><span class="token operator">/</span>
    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
    <span class="token operator">|</span>               <span class="token operator">|</span>                                   <span class="token operator">|</span>               <span class="token operator">|</span>
    <span class="token operator">|</span>       <span class="token punctuation">[</span> <span class="token class-name">Socket</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span>                    <span class="token punctuation">[</span> <span class="token class-name">Socket</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span>     <span class="token operator">|</span>
    <span class="token operator">|</span>                                                                   <span class="token operator">|</span>
    <span class="token operator">|</span>  <span class="token class-name">Netty</span> <span class="token class-name">Internal</span> <span class="token class-name">I</span><span class="token operator">/</span><span class="token class-name">O</span> <span class="token class-name">Threads</span> <span class="token punctuation">(</span><span class="token class-name">Transport</span> <span class="token class-name">Implementation</span><span class="token punctuation">)</span>            <span class="token operator">|</span>
    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
</code></pre></div><h2 id="netty缓冲区"><a href="#netty缓冲区" class="header-anchor">#</a> Netty缓冲区</h2> <p>Netty为了提高传输数据的效率，在写出数据时，会先将数据（ByteBuf）缓存到ChannelOutboundBuffer中，等到调用flush方法时才会将ChannelOutboundBuffer中的数据写入到socket缓冲区。</p> <p>ChannelOutboundBuffer中有三个重要属性：</p> <div class="language-java extra-class"><pre class="language-java"><code>## 链表中已刷新的开始节点
<span class="token keyword">private</span> <span class="token class-name">Entry</span> flushedEntry<span class="token punctuation">;</span>
## 链表中第一个未刷新的节点
<span class="token keyword">private</span> <span class="token class-name">Entry</span> unflushedEntry<span class="token punctuation">;</span>
## 链表中最后一个节点
<span class="token keyword">private</span> <span class="token class-name">Entry</span> tailEntry<span class="token punctuation">;</span>
</code></pre></div><p>从其属性可以看出，ChannelOutboundBuffer内部是一个链表结构，里面有三个指针:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Entry</span><span class="token punctuation">(</span>flushedEntry<span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>unflushedEntry<span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>tailEntry<span class="token punctuation">)</span>
</code></pre></div><p>ChannelOutboundBuffer中有两个比较重要的方法，addMessage：将数据以链表形式缓存下来，addFlush：移动链表指针，将缓存的数据标记为已刷新，注意此时并没有将数据写入到socket缓冲区。接下来我们看下两个方法的实现：</p> <h3 id="addmessage"><a href="#addmessage" class="header-anchor">#</a> addMessage</h3> <p>我们进入其addMessage方法分析下它是怎么缓存数据的：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addMessage</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span> entry <span class="token operator">=</span> <span class="token class-name">Entry</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token function">total</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tailEntry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        flushedEntry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        tailEntry <span class="token operator">=</span> entry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">Entry</span> tail <span class="token operator">=</span> tailEntry<span class="token punctuation">;</span>
        tail<span class="token punctuation">.</span>next <span class="token operator">=</span> entry<span class="token punctuation">;</span>
        tailEntry <span class="token operator">=</span> entry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>unflushedEntry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        unflushedEntry <span class="token operator">=</span> entry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">incrementPendingOutboundBytes</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当第一次添加数据数，会将数据封装为Entry，此时tailEntry、unflushedEntry指针指向这个Entry，flushedEntry指针此时为null。每次添加数据都会生成新的Entry，并将tailEntry指针指向该Entry，而unflushedEntry指针则一直指向最初添加的Entry，我们通过画图展示下：</p> <p>第一次添加：</p> <p><img src="/assets/img/flush_1.0ecec851.png" alt="cea11f03bddf5fa1ae64f5717cbc96b9">
第N次添加：</p> <p><img src="/assets/img/flush_2.efac7f96.png" alt="cea11f03bddf5fa1ae64f5717cbc96b9"></p> <p>为了防止缓存数据过大，Netty对缓存数据的大小做了限制：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">incrementPendingOutboundBytes</span><span class="token punctuation">(</span><span class="token keyword">long</span> size<span class="token punctuation">,</span> <span class="token keyword">boolean</span> invokeLater<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">long</span> newWriteBufferSize <span class="token operator">=</span> TOTAL_PENDING_SIZE_UPDATER<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newWriteBufferSize <span class="token operator">&gt;</span> channel<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWriteBufferHighWaterMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setUnwritable</span><span class="token punctuation">(</span>invokeLater<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>addMessage方法最后会调用incrementPendingOutboundBytes方法记录已缓存的数据大小（totalPendingSize），如果该大小超过了写缓冲区高水位阈值（默认64K），则更新不可写标志（unwritable），并传播Channel可写状态发生变化事件：fireChannelWritabilityChanged：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setUnwritable</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> invokeLater<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> oldValue <span class="token operator">=</span> unwritable<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> newValue <span class="token operator">=</span> oldValue <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>UNWRITABLE_UPDATER<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldValue <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> newValue <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">fireChannelWritabilityChanged</span><span class="token punctuation">(</span>invokeLater<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="addflush"><a href="#addflush" class="header-anchor">#</a> addFlush</h3> <p>移动链表指针，将缓存的数据标记为已刷新，并设置每个数据节点状态为不可取消：</p> <div class="language- extra-class"><pre class="language-text"><code>public void addFlush() {
    Entry entry = unflushedEntry;
    if (entry != null) {
        if (flushedEntry == null) {
            // there is no flushedEntry yet, so start with the entry
            flushedEntry = entry;
        }
        do {
            flushed ++;
            // 设置为不能取消，如果设置失败则说明该ByteBuf已经被取消，需要释放内存并更新totalPendingSize大小
            // 如果totalPendingSize小于缓冲区低水位阈值（默认32K）则更新不可写标志（unwritable），
            // 并传播Channel可写状态发生变化事件
            if (!entry.promise.setUncancellable()) {
                // Was cancelled so make sure we free up memory and notify about the freed bytes
                int pending = entry.cancel();
                decrementPendingOutboundBytes(pending, false, true);
            }
            entry = entry.next;
        } while (entry != null);

        // All flushed so reset unflushedEntry
        unflushedEntry = null;
    }
}
</code></pre></div><p>执行完addFlush方法后，链表图示如下：</p> <p><img src="/assets/img/flush_3.81bb6d5d.png" alt="cea11f03bddf5fa1ae64f5717cbc96b9"></p> <h2 id="数据传输"><a href="#数据传输" class="header-anchor">#</a> 数据传输</h2> <p>通过ChannelHandlerContext#writeAndFlush方法来分析下Netty是如何将数据通过网络进行传输的：</p> <div class="language-java extra-class"><pre class="language-java"><code>ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token string">&quot;just test it&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ChannelHandlerContext#writeAndFlush方法最终会调用其子类AbstractChannelHandlerContext的writeAndFlush方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>#<span class="token class-name">AbstractChannelHandlerContext</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">validatePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ReferenceCountUtil</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// cancelled</span>
        <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
		
    <span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>主要逻辑在write方法中：</p> <div class="language-java extra-class"><pre class="language-java"><code>#<span class="token class-name">AbstractChannelHandlerContext</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token keyword">boolean</span> flush<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">// 找到下一个ChannelHandlerContext</span>
    <span class="token class-name">AbstractChannelHandlerContext</span> next <span class="token operator">=</span> <span class="token function">findContextOutbound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Object</span> m <span class="token operator">=</span> pipeline<span class="token punctuation">.</span><span class="token function">touch</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 判断是否在IO线程中执行</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flush<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          	<span class="token comment">// 调用下一个ChannelHandlerContext的writeAndFlush方法</span>
            next<span class="token punctuation">.</span><span class="token function">invokeWriteAndFlush</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            next<span class="token punctuation">.</span><span class="token function">invokeWrite</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">AbstractWriteTask</span> task<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flush<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            task <span class="token operator">=</span> <span class="token class-name">WriteAndFlushTask</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> m<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>  <span class="token keyword">else</span> <span class="token punctuation">{</span>
            task <span class="token operator">=</span> <span class="token class-name">WriteTask</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> m<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">safeExecute</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> task<span class="token punctuation">,</span> promise<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>write方法主要做了两件事，一是：找到下一个ChannelHandlerContext。二是：调用下一个ChannelHandlerContext的w riteAndFlush方法传播事件。writeAndFlush方法是一个出站事件，前面我们也讲过对于出站事件，通过ChannelHandlerContext进行事件传播，事件是从pipline链中找到当前ChannelHandlerContext的下一个ChannelHandlerContext进行传播直至头部（HeadContext），在这期间我们需要自定义编码器对传输的Java对象进行编码，转换为ByteBuf对象，最终事件会传递到HeadContext进行处理。</p> <div class="language-java extra-class"><pre class="language-java"><code>#<span class="token class-name">AbstractChannelHandlerContext</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeWriteAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">invokeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invokeWrite0</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">invokeFlush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">writeAndFlush</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>invokeWriteAndFlush方法主要做了两件事，一是：调用invokeWrite0方法将数据放入Netty缓冲区中（ChannelOutboundBuffer），二是：调用invokeFlush0方法将缓冲区数据通过NioSocketChannel写入到socket缓冲区。</p> <h3 id="写入netty缓冲区"><a href="#写入netty缓冲区" class="header-anchor">#</a> 写入Netty缓冲区</h3> <p>invokeWrite0方法内部会调用ChannelOutboundHandler#write方法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeWrite0</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">)</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">notifyOutboundHandlerException</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>前面说过，出站事件最终会传播到HeadContext，在传播到HeadContext之前我们需要自定义编码器对Java对象进行编码，将Java对象编码为ByteBuf，关于编码器本章节暂不进行解析。我们进入HeadContext的write方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>#<span class="token class-name">DefaultChannelPipeline</span>#<span class="token class-name">HeadContext</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    unsafe<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>HeadContext#write方法中会调用AbstractChannelUnsafe#write方法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assertEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ChannelOutboundBuffer</span> outboundBuffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>outboundBuffer<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>outboundBuffer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">safeSetFailure</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> WRITE_CLOSED_CHANNEL_EXCEPTION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// release message now to prevent resource-leak</span>
        <span class="token class-name">ReferenceCountUtil</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> size<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      	<span class="token comment">// 对数据进行过滤转换</span>
        msg <span class="token operator">=</span> <span class="token function">filterOutboundMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// 估测数据大小</span>
        size <span class="token operator">=</span> pipeline<span class="token punctuation">.</span><span class="token function">estimatorHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">safeSetFailure</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ReferenceCountUtil</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
		<span class="token comment">// 缓存数据</span>
    outboundBuffer<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> size<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>该方法主要做了三件事情，一：对数据进行过滤转换，二：估测数据大小，三：缓存数据。我们先看下filterOutboundMessage方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>#<span class="token class-name">AbstractNioByteChannel</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> <span class="token function">filterOutboundMessage</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ByteBuf</span> buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">isDirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token function">newDirectBuffer</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">FileRegion</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span>
            <span class="token string">&quot;unsupported message type: &quot;</span> <span class="token operator">+</span> <span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">simpleClassName</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">+</span> EXPECTED_TYPES<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>一、对数据进行过滤转换：</p> <p>filterOutboundMessage方法首先会对数据进行过滤，如果数据不是ByteBuf或者FileRegion类型，则直接抛出异常。如果数据是ByteBuf类型，则判断数据是否为直接直接内存，如果不是则转换为直接内存以提升性能。</p> <p>二、估测数据大小：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> msg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">ByteBufHolder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ByteBufHolder</span><span class="token punctuation">)</span> msg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">FileRegion</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> unknownSize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>三、缓存数据：</p> <p>最后会调用ChannelOutboundBuffer#addMessage方法将数据缓存到链表中，关于addMessage方法可以回顾下文章中的Netty缓冲区部分。</p> <h3 id="写入socket缓冲区"><a href="#写入socket缓冲区" class="header-anchor">#</a> 写入Socket缓冲区</h3> <p>回到AbstractChannelHandlerContext#invokeWriteAndFlush方法，方法内部在调用完invokeWrite0方法将数据放入到缓存后，会调用invokeFlush0方法，将缓存中的数据写入到socket缓冲区。invokeFlush0方法内部会调用ChannelOutboundHandler#flush方法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeFlush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">)</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">notifyHandlerException</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>flush方法最终会将事件传播到HeadContext的flush方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>#<span class="token class-name">DefaultChannelPipeline</span>#<span class="token class-name">HeadContext</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    unsafe<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>HeadContext#flush方法中会调用AbstractChannelUnsafe#flush方法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assertEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ChannelOutboundBuffer</span> outboundBuffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>outboundBuffer<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>outboundBuffer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    outboundBuffer<span class="token punctuation">.</span><span class="token function">addFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">flush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>方法主要做了两件事，一：调用ChannelOutboundBuffer#addFlush方法，移动链表指针，将缓存的数据标记为已刷新。二：调用flush0方法将缓存中数据写入到socket缓冲区。关于addFlush方法可以看文中Netty缓冲区部分，我们直接进入flush0方法：</p> <div class="language-java extra-class"><pre class="language-java"><code>#<span class="token class-name">AbstractNioChannel</span>#<span class="token class-name">AbstractNioUnsafe</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">flush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Flush immediately only when there's no pending flush.</span>
    <span class="token comment">// If there's a pending flush operation, event loop will call forceFlush() later,</span>
    <span class="token comment">// and thus there's no need to call it now.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFlushPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">flush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>flush0方法主要做了两件事，一：判断是否有挂起的刷新。二：调用父类flush0方法。</p> <p>一、判断是否有挂起的刷新</p> <p>文中提到写入数据时，当socket缓冲区没有可用空间时会设置不可写状态，并注册OP_WRITE事件，等待socket缓冲区有空闲空间时会触发forceFlush，我们进入到isFlushPending方法看下方法是如何判断的：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isFlushPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SelectionKey</span> selectionKey <span class="token operator">=</span> <span class="token function">selectionKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> selectionKey<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>selectionKey<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span>OP_WRITE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>二、调用父类flush0方法</p> <p>写入socket缓冲区的具体逻辑在AbstractNioChannel#AbstractNioUnsafe父类AbstractChannel#AbstractUnsafe中：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">flush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">final</span> <span class="token class-name">ChannelOutboundBuffer</span> outboundBuffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>outboundBuffer<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>outboundBuffer <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> outboundBuffer<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">doWrite</span><span class="token punctuation">(</span>outboundBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// ...} finally {</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>核心逻辑在doWrite方法中，我们进入到AbstractChannel子类NioSocketChannel的doWrite方法看下具体实现：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doWrite</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundBuffer</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> size <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 所有数据已写完，清除OP_WRITE事件</span>
            <span class="token function">clearOpWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span> writtenBytes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> done <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> setOpWrite <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token comment">// 将缓存中flushed指针对应的的ByteBuf链表转换为ByteBuffer数组</span>
        <span class="token class-name">ByteBuffer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nioBuffers <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">nioBuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// ByteBuffer数量</span>
        <span class="token keyword">int</span> nioBufferCnt <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">nioBufferCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// ByteBuffer数组中写入的字节数</span>
        <span class="token keyword">long</span> expectedWrittenBytes <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">nioBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// 获取Java NIO底层的NioSocketChannel</span>
        <span class="token class-name">SocketChannel</span> ch <span class="token operator">=</span> <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 根据ByteBuffer数量执行不同的写逻辑</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>nioBufferCnt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 0表示需要写入的数据为FileRegion类型</span>
            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">doWrite</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果只有一个ByteBuf则调用非聚集写</span>
            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
                <span class="token class-name">ByteBuffer</span> nioBuffer <span class="token operator">=</span> nioBuffers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            		<span class="token comment">// 写自旋次数，默认为16</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWriteSpinCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">int</span> localWrittenBytes <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>nioBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  	<span class="token comment">// 如果已写字节为0，则表示socket缓冲区已满，需要注册OP_WRITE事件</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>localWrittenBytes <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        setOpWrite <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    expectedWrittenBytes <span class="token operator">-=</span> localWrittenBytes<span class="token punctuation">;</span>
                    writtenBytes <span class="token operator">+=</span> localWrittenBytes<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>expectedWrittenBytes <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWriteSpinCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> localWrittenBytes <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>nioBuffers<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> nioBufferCnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>localWrittenBytes <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        setOpWrite <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    expectedWrittenBytes <span class="token operator">-=</span> localWrittenBytes<span class="token punctuation">;</span>
                    writtenBytes <span class="token operator">+=</span> localWrittenBytes<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>expectedWrittenBytes <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 释放完全写入的缓冲区，并更新部分写入的缓冲区的索引</span>
        in<span class="token punctuation">.</span><span class="token function">removeBytes</span><span class="token punctuation">(</span>writtenBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Did not write all buffers completely.</span>
            <span class="token function">incompleteWrite</span><span class="token punctuation">(</span>setOpWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>NioSocketChannel#doWrite方法根据nioBufferCnt大小执行不同的写逻辑，如果为0则调用AbstractNioByteChannel#doWrite方法。如果nioBufferCnt为1或者大于1，则调用NioSocketChannel不同的重载方法进行处理。注意，写数据时自旋次数默认为16，也就是说如果执行16次write后仍有数据未写完，则调用incompleteWrite方法将flush操作封装为一个任务，放入到队列中，目的是不阻塞其他任务。另外，如果调用NioSocketChannel#write方法后，返回的localWrittenBytes为0，则表示socket缓冲区空间不足，则注册OP_WRITE事件，等待有可用空间时会触发该事件，然后调用forceFlush方法继续写入数据。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/netty/netty_memory.html" class="prev">Netty内存分配</a></span> <span class="next"><a href="/netty/netty_codec.html">Netty编解码</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><div class="qrcode_container" data-v-5687ca4d><div class="tencent_code" data-v-5687ca4d><h4 data-v-5687ca4d>关注作者公众</h4> <p data-v-5687ca4d>和万千小伙伴一起学习</p> <img src="/ggh.jpg" alt data-v-5687ca4d></div> <div class="group_code" data-v-5687ca4d><h4 data-v-5687ca4d>加入技术交流群</h4> <p data-v-5687ca4d>扫描二维码 备注<span data-v-5687ca4d> 加群</span></p> <img src="/wechat.jpg" alt data-v-5687ca4d></div></div><!----></div></div>
    <script src="/assets/js/app.c279a524.js" defer></script><script src="/assets/js/2.0c1afcb6.js" defer></script><script src="/assets/js/9.b79e982a.js" defer></script><script src="/assets/js/7.84ef9767.js" defer></script><script src="/assets/js/12.f1c48cfc.js" defer></script><script src="/assets/js/13.70bd7ce1.js" defer></script>
  </body>
</html>
