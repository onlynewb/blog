<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Netty内存管理 | 永远滴神</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="shortcut icon" href="/favicon.ico" type="iamge/x-icon">
    <meta name="description" content="一个用心帮助你成长的公众号">
    <meta name="keywords" content="永远滴神 后端 公众号">
    
    <link rel="preload" href="/assets/css/0.styles.82a4f3fa.css" as="style"><link rel="preload" href="/assets/js/app.c279a524.js" as="script"><link rel="preload" href="/assets/js/2.0c1afcb6.js" as="script"><link rel="preload" href="/assets/js/6.c54a32fc.js" as="script"><link rel="preload" href="/assets/js/7.84ef9767.js" as="script"><link rel="preload" href="/assets/js/12.f1c48cfc.js" as="script"><link rel="preload" href="/assets/js/13.70bd7ce1.js" as="script"><link rel="prefetch" href="/assets/js/10.e26101b4.js"><link rel="prefetch" href="/assets/js/11.9f39b567.js"><link rel="prefetch" href="/assets/js/14.2b6f6c3d.js"><link rel="prefetch" href="/assets/js/15.a79a89f0.js"><link rel="prefetch" href="/assets/js/16.4b42d084.js"><link rel="prefetch" href="/assets/js/17.a9cce4ad.js"><link rel="prefetch" href="/assets/js/18.fbbc06c5.js"><link rel="prefetch" href="/assets/js/19.a05e6a7c.js"><link rel="prefetch" href="/assets/js/20.9a58f68f.js"><link rel="prefetch" href="/assets/js/21.a2a6463a.js"><link rel="prefetch" href="/assets/js/22.8214d8b2.js"><link rel="prefetch" href="/assets/js/23.8cbb570e.js"><link rel="prefetch" href="/assets/js/24.48aa175f.js"><link rel="prefetch" href="/assets/js/25.84608df8.js"><link rel="prefetch" href="/assets/js/26.305db893.js"><link rel="prefetch" href="/assets/js/27.206035f7.js"><link rel="prefetch" href="/assets/js/28.67715c64.js"><link rel="prefetch" href="/assets/js/29.14071b9d.js"><link rel="prefetch" href="/assets/js/3.31bcfe44.js"><link rel="prefetch" href="/assets/js/30.dc0684e5.js"><link rel="prefetch" href="/assets/js/31.883ad823.js"><link rel="prefetch" href="/assets/js/32.ecf2894d.js"><link rel="prefetch" href="/assets/js/33.aff8d5e4.js"><link rel="prefetch" href="/assets/js/34.be686b6a.js"><link rel="prefetch" href="/assets/js/35.c0cb3ba1.js"><link rel="prefetch" href="/assets/js/36.a002f118.js"><link rel="prefetch" href="/assets/js/37.e76eaea2.js"><link rel="prefetch" href="/assets/js/38.b4604ac1.js"><link rel="prefetch" href="/assets/js/39.763c67c0.js"><link rel="prefetch" href="/assets/js/4.d0009a91.js"><link rel="prefetch" href="/assets/js/40.b9fd76a7.js"><link rel="prefetch" href="/assets/js/41.a42f44ff.js"><link rel="prefetch" href="/assets/js/42.b52500a4.js"><link rel="prefetch" href="/assets/js/43.eb1e5211.js"><link rel="prefetch" href="/assets/js/44.2cb493cd.js"><link rel="prefetch" href="/assets/js/45.d7f0976e.js"><link rel="prefetch" href="/assets/js/46.7ffb8b39.js"><link rel="prefetch" href="/assets/js/47.2967a68c.js"><link rel="prefetch" href="/assets/js/48.35389a81.js"><link rel="prefetch" href="/assets/js/49.0d17f7bc.js"><link rel="prefetch" href="/assets/js/5.c42b1e5e.js"><link rel="prefetch" href="/assets/js/50.9ca014f6.js"><link rel="prefetch" href="/assets/js/51.5956567e.js"><link rel="prefetch" href="/assets/js/52.6da5773a.js"><link rel="prefetch" href="/assets/js/53.030556f0.js"><link rel="prefetch" href="/assets/js/54.e54a1605.js"><link rel="prefetch" href="/assets/js/55.0f443484.js"><link rel="prefetch" href="/assets/js/56.b77dce48.js"><link rel="prefetch" href="/assets/js/57.e8803295.js"><link rel="prefetch" href="/assets/js/58.eeb1ac26.js"><link rel="prefetch" href="/assets/js/59.0b9b5c35.js"><link rel="prefetch" href="/assets/js/60.f3b0cf20.js"><link rel="prefetch" href="/assets/js/61.b2b65094.js"><link rel="prefetch" href="/assets/js/62.b5df885c.js"><link rel="prefetch" href="/assets/js/63.029e4e19.js"><link rel="prefetch" href="/assets/js/64.c96e2154.js"><link rel="prefetch" href="/assets/js/65.9de74a66.js"><link rel="prefetch" href="/assets/js/66.194ed1ac.js"><link rel="prefetch" href="/assets/js/67.7d6aae93.js"><link rel="prefetch" href="/assets/js/68.469ec24a.js"><link rel="prefetch" href="/assets/js/69.66f2fcf5.js"><link rel="prefetch" href="/assets/js/70.876f0081.js"><link rel="prefetch" href="/assets/js/71.f7f93b2e.js"><link rel="prefetch" href="/assets/js/72.ba2032df.js"><link rel="prefetch" href="/assets/js/73.82cdb3d0.js"><link rel="prefetch" href="/assets/js/74.13d1084f.js"><link rel="prefetch" href="/assets/js/75.2e4b95b9.js"><link rel="prefetch" href="/assets/js/76.c3c1eaba.js"><link rel="prefetch" href="/assets/js/77.5674dbce.js"><link rel="prefetch" href="/assets/js/78.6b1fb7a6.js"><link rel="prefetch" href="/assets/js/79.5920b2ff.js"><link rel="prefetch" href="/assets/js/8.1bdaa967.js"><link rel="prefetch" href="/assets/js/80.cb244441.js"><link rel="prefetch" href="/assets/js/81.f6440a0e.js"><link rel="prefetch" href="/assets/js/82.0ec434bf.js"><link rel="prefetch" href="/assets/js/83.f3186073.js"><link rel="prefetch" href="/assets/js/9.b79e982a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.82a4f3fa.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/home.png" alt="永远滴神" class="logo"> <span class="site-name can-hide">永远滴神</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/node/" class="nav-link">node</a></div><div class="nav-item"><a href="/netty/" class="nav-link router-link-active">netty</a></div><div class="nav-item"><a href="/database/" class="nav-link">数据库</a></div><div class="nav-item"><a href="/interview/" class="nav-link">面试问题</a></div><div class="nav-item"><a href="https://github.com/koala-coding/FE-Infer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  招聘●内推
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/about/2019_year_end.html" class="nav-link">关于我</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/node/" class="nav-link">node</a></div><div class="nav-item"><a href="/netty/" class="nav-link router-link-active">netty</a></div><div class="nav-item"><a href="/database/" class="nav-link">数据库</a></div><div class="nav-item"><a href="/interview/" class="nav-link">面试问题</a></div><div class="nav-item"><a href="https://github.com/koala-coding/FE-Infer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  招聘●内推
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/about/2019_year_end.html" class="nav-link">关于我</a></div> <!----></nav> <div class="my_introduce" style="padding-left:1rem;"><div class="introduce_component" data-v-37981958><img src="/small.png" alt data-v-37981958> <div class="intro_content" data-v-37981958><h3 data-v-37981958>公众号:程序员成长指北</h3> <p data-v-37981958>koala 学习成长之路</p></div></div></div> <ul class="sidebar-links"><li><a href="/netty/io.html" class="sidebar-link">IO读写原理与IO模型</a></li><li><a href="/netty/netty_thread_mode.html" class="sidebar-link">Netty线程模型</a></li><li><a href="/netty/netty_server_start.html" class="sidebar-link">Netty服务端启动流程</a></li><li><a href="/netty/netty_task.html" class="sidebar-link">Netty IO事件与任务处理</a></li><li><a href="/netty/netty_memory.html" aria-current="page" class="active sidebar-link">Netty内存分配</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/netty/netty_memory.html#概述" class="sidebar-link">概述</a></li><li class="sidebar-sub-header"><a href="/netty/netty_memory.html#bytebuf数据结构" class="sidebar-link">ByteBuf数据结构</a></li><li class="sidebar-sub-header"><a href="/netty/netty_memory.html#bytebuf类图" class="sidebar-link">ByteBuf类图</a></li><li class="sidebar-sub-header"><a href="/netty/netty_memory.html#内存管理" class="sidebar-link">内存管理</a></li></ul></li><li><a href="/netty/netty_write_and_flush.html" class="sidebar-link">Netty writeAndFlush解析</a></li><li><a href="/netty/netty_codec.html" class="sidebar-link">Netty编解码</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="netty内存管理"><a href="#netty内存管理" class="header-anchor">#</a> Netty内存管理</h1> <h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <blockquote><p>Netty使用ByteBuf作为其底层数据传输的容器，其实现有两种方式：基于堆内存与基于直接内存。为了减少传输过程中在用户缓冲区与内核缓冲区数据拷贝带来的消耗，底层实现又分为unsafe与非unsafe两种方式。同时为了降低内存分配与释放消耗，采用池化方式对ByteBuf进行缓存。</p></blockquote> <h2 id="bytebuf数据结构"><a href="#bytebuf数据结构" class="header-anchor">#</a> ByteBuf数据结构</h2> <p>ByteBuf底层是一个字节数组，内部维护了两个索引：readerIndex与writerIndex。其中0 --&gt; readerIndex部分为可丢弃字节，表示已被读取过，readerIndex --&gt; writerIndex部分为可读字节，writerIndex --&gt; capacity部分为可写字节。ByteBuf支持动态扩容，在实例化时会传入maxCapacity，当writerIndex达到capacity且capacity小于maxCapacity时会进行自动扩容。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> discardable bytes <span class="token operator">|</span>  readable bytes  <span class="token operator">|</span>  writable bytes  <span class="token operator">|</span>
<span class="token operator">|</span>                   <span class="token operator">|</span>     <span class="token punctuation">(</span>CONTENT<span class="token punctuation">)</span>    <span class="token operator">|</span>                  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span>                   <span class="token operator">|</span>                  <span class="token operator">|</span>                  <span class="token operator">|</span>
<span class="token number">0</span>      <span class="token operator">&lt;=</span>      readerIndex   <span class="token operator">&lt;=</span>   writerIndex    <span class="token operator">&lt;=</span>    capacity
</code></pre></div><h2 id="bytebuf类图"><a href="#bytebuf类图" class="header-anchor">#</a> ByteBuf类图</h2> <p><img src="/assets/img/memory_1.db025453.png" alt="cea11f03bddf5fa1ae64f5717cbc96b9"></p> <p>ByteBuf子类可以按照以下三个纬度进行分类：</p> <ul><li><p>**池化与非池化：**是否对ByteBuf进行缓存</p></li> <li><p>**unsafe与非unsafe：**是否使用unsafe进行读写</p></li> <li><p>**堆内存与直接内存：**在堆内存或者直接内存进行分配</p></li></ul> <h2 id="内存管理"><a href="#内存管理" class="header-anchor">#</a> 内存管理</h2> <p>在进入内存分配核心逻辑前，我们先对Netty内存分配相关概念做下了解。Netty内存管理借鉴jemalloc思想，为了提高内存利用率，根据不同内存规格使用不同的分配策略，并且使用缓存提高内存分配效率。</p> <h3 id="内存分配相关概念"><a href="#内存分配相关概念" class="header-anchor">#</a> 内存分配相关概念</h3> <h4 id="内存规格"><a href="#内存规格" class="header-anchor">#</a> 内存规格</h4> <p><img src="/assets/img/memory_2.0c9ef267.png" alt="cea11f03bddf5fa1ae64f5717cbc96b9"></p> <p>Netty有四种内存规格，tiny表示16B ~ 512B之间的内存块，samll表示512B ~ 8K之间的内存块，normal表示8K ~ 16M的内存块，Huge表示大于16M的内存块。</p> <p>Chunk是Netty向操作系统申请内存的单位，默认一次向操作系统申请16M内存，Netty内部将Chunk按照Page大小划分为2048块。我们申请内存时如果大于16M，则Netty会直接向操作系统申请对应大小内存，如果申请内存在8k到16M之间则会分配对应个数Page进行使用。如果申请内存远小于8K，那么直接使用一个Page会造成内存浪费，SubPage就是对Page进行再次分配，减少内存浪费。</p> <p>如果申请内存小于8K，会对Page进行再次划分为SubPage，SubPage大小为Page大小/申请内存大小。SubPage又划分为tiny与small两种。</p> <h4 id="poolarena"><a href="#poolarena" class="header-anchor">#</a> PoolArena</h4> <p>负责管理从操作系统中申请到的内存块，Netty为了减少多线程竞争arena，采用多arena设计，arena数量默认为2倍CPU核心数。线程与arena关系如下：</p> <p><img src="/assets/img/memory_3.6deb9939.png" alt="cea11f03bddf5fa1ae64f5717cbc96b9"></p> <h4 id="poolthreadlocalcache"><a href="#poolthreadlocalcache" class="header-anchor">#</a> PoolThreadLocalCache</h4> <p>线程本地缓存，负责创建线程缓存PoolThreadCache。PoolThreadCache中会初始化三种类型MemoryRegionCache数组，用以缓存线程中不同规格的内存块，分别为：tiny、small、normal。tiny类型数组缓存的内存块大小为16B ~ 512B之间，samll类型数组缓存的内存块大小为512B ~ 8K之间的内存块，normal类型数组缓存的内存块大小受DEFAULT_MAX_CACHED_BUFFER_CAPACITY配置影响，默认只缓存8K、16K、32K三种类型内存块。</p> <h4 id="memoryregioncache"><a href="#memoryregioncache" class="header-anchor">#</a> MemoryRegionCache</h4> <p>内存块缓存容器，负责缓存tiny、small、normal三种内存块。其内部维护一个队列，用于缓存同种内存大小的内存块。</p> <h4 id="poolchunk"><a href="#poolchunk" class="header-anchor">#</a> PoolChunk</h4> <p>负责管理从操作系统申请的内存，内部采用伙伴算法以Page为单位进行内存的分配与管理。</p> <p><img src="/assets/img/memory_4.6d35538a.png" alt="cea11f03bddf5fa1ae64f5717cbc96b9"></p> <h4 id="poolchunklist"><a href="#poolchunklist" class="header-anchor">#</a> PoolChunkList</h4> <p>负责管理Chunk列表，根据内存使用率，分为：qInit、q000、q025、q050、q075、q100六种。每个PoolChunkList中存储内存使用率相同的Chunk，Chunk以双向链表进行关联，同时不同使用率的PoolChunkList也以双向列表进行关联。这样做的目的是因为随着内存的分配，Chunk使用率会发生变化，以链表形式方便Chunk在不同使用率列表进行移动。</p> <p><img src="/assets/img/memory_5.22aa053c.png" alt="cea11f03bddf5fa1ae64f5717cbc96b9"></p> <h4 id="poolsubpage"><a href="#poolsubpage" class="header-anchor">#</a> PoolSubpage</h4> <p>PoolSubpage负责tiny、small类型内存的管理与分配，实现基于SLAB内存分配算法。PoolArena中有两种PoolSubpage类型数组，分别为：tinySubpagePools、smallSubpagePools。tinySubpagePools负责管理tiny类型内存，数组大小为512/16=32种。smallSubpagePools负责管理small类型内存，数组大小为4。</p> <p>PoolSubpage数组中存储不同内存大小的PoolSubpage节点，相同大小节点以链表进行关联。PoolSubpage内部使用位图数组记录内存分配情况。</p> <h3 id="内存分配器"><a href="#内存分配器" class="header-anchor">#</a> 内存分配器</h3> <p>Netty通过ByteBufAllocator进行内存分配，ByteBufAllocator有两个实现类：PooledByteBufAllocator与UnpooledByteBufAllocator，其中，是否在堆内存或者直接内存分配与是否使用unsafe进行读写操作都封装在其实现类中。</p> <p>我们先看下ByteBufAllocator类图：</p> <p><img src="/assets/img/memory_6.91e8ccdc.png" alt="cea11f03bddf5fa1ae64f5717cbc96b9"></p> <p>PooledByteBufAllocator与UnpooledByteBufAllocator内存分配类似，可以通过newHeapBuffer与newDirectBuffer进行分配内存，我们以PooledByteBufAllocator为例分析下内存分配流程：</p> <h4 id="实例化内存分配器"><a href="#实例化内存分配器" class="header-anchor">#</a> 实例化内存分配器</h4> <p>以PooledByteBufAllocator为例来分析下内存分配器实例化过程。首先调用PooledByteBufAllocator#DEFAULT方法实例化PooledByteBufAllocator</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">PooledByteBufAllocator</span> allocator <span class="token operator">=</span> <span class="token class-name">PooledByteBufAllocator</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">;</span>

#<span class="token class-name">PooledByteBufAllocator</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">PooledByteBufAllocator</span> DEFAULT <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">PooledByteBufAllocator</span><span class="token punctuation">(</span><span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token function">directBufferPreferred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>PooledByteBufAllocator实例化时会初始化几个比较重要的属性：</p> <ul><li>**DEFAULT_NUM_HEAP_ARENA：**heap类型arena数量，默认两倍CPU核心数</li> <li><strong>DEFAULT_NUM_DIRECT_ARENA：</strong> Arena数组长度，默认为两倍CPU核心数</li> <li>**DEFAULT_PAGE_SIZE：**页大小，默认为8K</li> <li>**DEFAULT_MAX_ORDER：**树深度，默认为11</li> <li>**DEFAULT_TINY_CACHE_SIZE：**缓存的tiny类型的内存个数，默认为512</li> <li>**DEFAULT_SMALL_CACHE_SIZE：**缓存的small类型的内存个数，默认为256</li> <li>**DEFAULT_NORMAL_CACHE_SIZE：**缓存的normal类型的内存个数，默认为64</li> <li>**DEFAULT_MAX_CACHED_BUFFER_CAPACITY：**最大可以被缓存的内存大小，默认为32K</li> <li>**DEFAULT_CACHE_TRIM_INTERVAL：**缓存经过多少次回收后被清理，默认为8192</li></ul> <p>最终会调用PooledByteBufAllocator如下构造方法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">PooledByteBufAllocator</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> preferDirect<span class="token punctuation">,</span> <span class="token keyword">int</span> nHeapArena<span class="token punctuation">,</span> <span class="token keyword">int</span> nDirectArena<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token keyword">int</span> maxOrder<span class="token punctuation">,</span>
                                  <span class="token keyword">int</span> tinyCacheSize<span class="token punctuation">,</span> <span class="token keyword">int</span> smallCacheSize<span class="token punctuation">,</span> <span class="token keyword">int</span> normalCacheSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  			<span class="token comment">// 调用父类构造方法初始化directByDefault属性（默认使用直接内存，默认值为true）、初始化一个空的ByteBuf对象</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>preferDirect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  			<span class="token comment">// 初始化threadCache属性，用于创建本地线程缓存</span>
        threadCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolThreadLocalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tinyCacheSize <span class="token operator">=</span> tinyCacheSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>smallCacheSize <span class="token operator">=</span> smallCacheSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>normalCacheSize <span class="token operator">=</span> normalCacheSize<span class="token punctuation">;</span>
        <span class="token comment">// ...</span>

  			<span class="token comment">// 初始化堆内存类型PoolArena数组</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nHeapArena <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            heapArenas <span class="token operator">=</span> <span class="token function">newArenaArray</span><span class="token punctuation">(</span>nHeapArena<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PoolArenaMetric</span><span class="token punctuation">&gt;</span></span> metrics <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PoolArenaMetric</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>heapArenas<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> heapArenas<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">PoolArena<span class="token punctuation">.</span>HeapArena</span> arena <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolArena<span class="token punctuation">.</span>HeapArena</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> maxOrder<span class="token punctuation">,</span> pageShifts<span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                heapArenas<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arena<span class="token punctuation">;</span>
                metrics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>arena<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            heapArenaMetrics <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>metrics<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            heapArenas <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            heapArenaMetrics <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
				<span class="token comment">// 初始化直接内存类型PoolArena数组</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nDirectArena <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            directArenas <span class="token operator">=</span> <span class="token function">newArenaArray</span><span class="token punctuation">(</span>nDirectArena<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PoolArenaMetric</span><span class="token punctuation">&gt;</span></span> metrics <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PoolArenaMetric</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>directArenas<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> directArenas<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">PoolArena<span class="token punctuation">.</span>DirectArena</span> arena <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolArena<span class="token punctuation">.</span>DirectArena</span><span class="token punctuation">(</span>
                        <span class="token keyword">this</span><span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> maxOrder<span class="token punctuation">,</span> pageShifts<span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                directArenas<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arena<span class="token punctuation">;</span>
                metrics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>arena<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            directArenaMetrics <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>metrics<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            directArenas <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            directArenaMetrics <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>PooledByteBufAllocator构造方法主要做了两件事情，一是：初始化PoolThreadLocalCache属性，二是：初始化堆内存与直接内存类型PoolArena数组，我们进入PoolArena.DirectArena构造方法，来分析下PoolArena初始化时主要做了哪些事情：</p> <div class="language-java extra-class"><pre class="language-java"><code>#<span class="token class-name">PoolArena<span class="token punctuation">.</span>DirectArena</span>
<span class="token class-name">DirectArena</span><span class="token punctuation">(</span><span class="token class-name">PooledByteBufAllocator</span> parent<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token keyword">int</span> maxOrder<span class="token punctuation">,</span> <span class="token keyword">int</span> pageShifts<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> maxOrder<span class="token punctuation">,</span> pageShifts<span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

#<span class="token class-name">PoolArena</span>
<span class="token keyword">protected</span> <span class="token class-name">PoolArena</span><span class="token punctuation">(</span><span class="token class-name">PooledByteBufAllocator</span> parent<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token keyword">int</span> maxOrder<span class="token punctuation">,</span> <span class="token keyword">int</span> pageShifts<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pageSize <span class="token operator">=</span> pageSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxOrder <span class="token operator">=</span> maxOrder<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pageShifts <span class="token operator">=</span> pageShifts<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chunkSize <span class="token operator">=</span> chunkSize<span class="token punctuation">;</span>
        subpageOverflowMask <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>pageSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  			## 初始化tiny类型<span class="token class-name">PoolSubpage</span>数组
        tinySubpagePools <span class="token operator">=</span> <span class="token function">newSubpagePoolArray</span><span class="token punctuation">(</span>numTinySubpagePools<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tinySubpagePools<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            tinySubpagePools<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newSubpagePoolHead</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        numSmallSubpagePools <span class="token operator">=</span> pageShifts <span class="token operator">-</span> <span class="token number">9</span><span class="token punctuation">;</span>
  			## 初始化small类型<span class="token class-name">PoolSubpage</span>数组
        smallSubpagePools <span class="token operator">=</span> <span class="token function">newSubpagePoolArray</span><span class="token punctuation">(</span>numSmallSubpagePools<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> smallSubpagePools<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            smallSubpagePools<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newSubpagePoolHead</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
				
  			##初始化<span class="token class-name">PoolChunkList</span>
        q100 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolChunkList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        q075 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolChunkList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>q100<span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        q050 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolChunkList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>q075<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        q025 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolChunkList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>q050<span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        q000 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolChunkList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>q025<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        qInit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolChunkList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>q000<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MIN_VALUE<span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

        q100<span class="token punctuation">.</span><span class="token function">prevList</span><span class="token punctuation">(</span>q075<span class="token punctuation">)</span><span class="token punctuation">;</span>
        q075<span class="token punctuation">.</span><span class="token function">prevList</span><span class="token punctuation">(</span>q050<span class="token punctuation">)</span><span class="token punctuation">;</span>
        q050<span class="token punctuation">.</span><span class="token function">prevList</span><span class="token punctuation">(</span>q025<span class="token punctuation">)</span><span class="token punctuation">;</span>
        q025<span class="token punctuation">.</span><span class="token function">prevList</span><span class="token punctuation">(</span>q000<span class="token punctuation">)</span><span class="token punctuation">;</span>
        q000<span class="token punctuation">.</span><span class="token function">prevList</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        qInit<span class="token punctuation">.</span><span class="token function">prevList</span><span class="token punctuation">(</span>qInit<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PoolChunkListMetric</span><span class="token punctuation">&gt;</span></span> metrics <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PoolChunkListMetric</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        metrics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>qInit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        metrics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>q000<span class="token punctuation">)</span><span class="token punctuation">;</span>
        metrics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>q025<span class="token punctuation">)</span><span class="token punctuation">;</span>
        metrics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>q050<span class="token punctuation">)</span><span class="token punctuation">;</span>
        metrics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>q075<span class="token punctuation">)</span><span class="token punctuation">;</span>
        metrics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>q100<span class="token punctuation">)</span><span class="token punctuation">;</span>
        chunkListMetrics <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>metrics<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>DirectArena构造方法会调用其父类PoolArena构造方法，在PoolArena构造方法中会初始化tiny类型与small类型PoolSubpage数组，并初始化六种不同内存使用率的PoolChunkList，每个PoolChunkList以双向链表进行关联。</p> <h3 id="分配内存"><a href="#分配内存" class="header-anchor">#</a> 分配内存</h3> <p>以分配直接内存为例，分析内存分配的主要流程：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ByteBuf</span> byteBuf <span class="token operator">=</span> allocator<span class="token punctuation">.</span><span class="token function">directBuffer</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>PooledByteBufAllocator#directBuffer方法最终会调用如下构造方法，其中maxCapacity为Integer.MAX_VALUE：</p> <div class="language-java extra-class"><pre class="language-java"><code>#<span class="token class-name">PooledByteBufAllocator</span>
<span class="token keyword">protected</span> <span class="token class-name">ByteBuf</span> <span class="token function">newDirectBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> maxCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	## 获取线程缓存
    <span class="token class-name">PoolThreadCache</span> cache <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PoolThreadCache</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>threadCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	## 从线程缓存中获取<span class="token class-name">PoolArena</span>
    <span class="token class-name">PoolArena</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span> directArena <span class="token operator">=</span> cache<span class="token punctuation">.</span>directArena<span class="token punctuation">;</span>
    <span class="token class-name">Object</span> buf<span class="token punctuation">;</span>
  	## 分配内存
    <span class="token keyword">if</span> <span class="token punctuation">(</span>directArena <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buf <span class="token operator">=</span> directArena<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> initialCapacity<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        buf <span class="token operator">=</span> <span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token function">hasUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">UnsafeByteBufUtil</span><span class="token punctuation">.</span><span class="token function">newUnsafeDirectByteBuf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> initialCapacity<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">UnpooledDirectByteBuf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> initialCapacity<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
		## 将<span class="token class-name">ByteBuf</span>转为具有内存泄漏检测功能的<span class="token class-name">ByteBuf</span>
    <span class="token keyword">return</span> <span class="token function">toLeakAwareBuffer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>该方法主要分三步，第一步：获取线程缓存，第二步：分配内存，第三步：将ByteBuf转为具有内存泄漏检测功能的ByteBuf，我们来分析下每一步具体做了哪些事情：</p> <p>1.获取线程缓存，从PoolThreadLocalCache中获取PoolThreadCache，首次调用会先进行进行初始化，并将结果缓存下来：</p> <div class="language-java extra-class"><pre class="language-java"><code>#<span class="token class-name">FastThreadLocal</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">InternalThreadLocalMap</span> threadLocalMap <span class="token operator">=</span> <span class="token class-name">InternalThreadLocalMap</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> v <span class="token operator">=</span> threadLocalMap<span class="token punctuation">.</span><span class="token function">indexedVariable</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">!=</span> <span class="token class-name">InternalThreadLocalMap</span><span class="token punctuation">.</span>UNSET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">V</span><span class="token punctuation">)</span> v<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
		<span class="token comment">// 初始化PoolThreadCache</span>
    <span class="token keyword">return</span> <span class="token function">initialize</span><span class="token punctuation">(</span>threadLocalMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>初始化方法在PoolThreadLocalCache中，首先会循环找到使用最少的PoolArena，然后调用PoolThreadCache构造方法创建PoolThreadCache：</p> <div class="language-java extra-class"><pre class="language-java"><code>#<span class="token class-name">PoolThreadLocalCache</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">synchronized</span> <span class="token class-name">PoolThreadCache</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">// 获取使用最少的PoolArena</span>
    <span class="token keyword">final</span> <span class="token class-name">PoolArena</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> heapArena <span class="token operator">=</span> <span class="token function">leastUsedArena</span><span class="token punctuation">(</span>heapArenas<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">PoolArena</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span> directArena <span class="token operator">=</span> <span class="token function">leastUsedArena</span><span class="token punctuation">(</span>directArenas<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">/**
  		*heapArena、directArena为PoolArena数组大小，默认为2倍CPU核数
  		*tinyCacheSize tiny类型缓存池大小，默认为512
  		*smallCacheSize small类型缓存池大小，默认为256
  		*normalCacheSize normal类型缓存池大小，默认为64
  		*DEFAULT_MAX_CACHED_BUFFER_CAPACITY normal类型缓存池缓存的最大内存大小，默认为32K
  		*DEFAULT_CACHE_TRIM_INTERVAL 分配次数阈值默认为8192，超过后释放内存池
  	  */</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PoolThreadCache</span><span class="token punctuation">(</span>
            heapArena<span class="token punctuation">,</span> directArena<span class="token punctuation">,</span> tinyCacheSize<span class="token punctuation">,</span> smallCacheSize<span class="token punctuation">,</span> normalCacheSize<span class="token punctuation">,</span>
            DEFAULT_MAX_CACHED_BUFFER_CAPACITY<span class="token punctuation">,</span> DEFAULT_CACHE_TRIM_INTERVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>PoolThreadCache构造方法中会初始化tinySubPageDirectCaches、smallSubPageDirectCaches、normalDirectCaches这三种MemoryRegionCache数组：</p> <div class="language-java extra-class"><pre class="language-java"><code>#<span class="token class-name">PoolThreadCache</span>
<span class="token class-name">PoolThreadCache</span><span class="token punctuation">(</span><span class="token class-name">PoolArena</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> heapArena<span class="token punctuation">,</span> <span class="token class-name">PoolArena</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span> directArena<span class="token punctuation">,</span>
                <span class="token keyword">int</span> tinyCacheSize<span class="token punctuation">,</span> <span class="token keyword">int</span> smallCacheSize<span class="token punctuation">,</span> <span class="token keyword">int</span> normalCacheSize<span class="token punctuation">,</span>
                <span class="token keyword">int</span> maxCachedBufferCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> freeSweepAllocationThreshold<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>freeSweepAllocationThreshold <span class="token operator">=</span> freeSweepAllocationThreshold<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>heapArena <span class="token operator">=</span> heapArena<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>directArena <span class="token operator">=</span> directArena<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>directArena <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tinySubPageDirectCaches <span class="token operator">=</span> <span class="token function">createSubPageCaches</span><span class="token punctuation">(</span>
                tinyCacheSize<span class="token punctuation">,</span> <span class="token class-name">PoolArena</span><span class="token punctuation">.</span>numTinySubpagePools<span class="token punctuation">,</span> <span class="token class-name">SizeClass<span class="token punctuation">.</span>Tiny</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        smallSubPageDirectCaches <span class="token operator">=</span> <span class="token function">createSubPageCaches</span><span class="token punctuation">(</span>
                smallCacheSize<span class="token punctuation">,</span> directArena<span class="token punctuation">.</span>numSmallSubpagePools<span class="token punctuation">,</span> <span class="token class-name">SizeClass<span class="token punctuation">.</span>Small</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        numShiftsNormalDirect <span class="token operator">=</span> <span class="token function">log2</span><span class="token punctuation">(</span>directArena<span class="token punctuation">.</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        normalDirectCaches <span class="token operator">=</span> <span class="token function">createNormalCaches</span><span class="token punctuation">(</span>
                normalCacheSize<span class="token punctuation">,</span> maxCachedBufferCapacity<span class="token punctuation">,</span> directArena<span class="token punctuation">)</span><span class="token punctuation">;</span>

        directArena<span class="token punctuation">.</span>numThreadCaches<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// No directArea is configured so just null out all caches</span>
        tinySubPageDirectCaches <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        smallSubPageDirectCaches <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        normalDirectCaches <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        numShiftsNormalDirect <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>createSubPageCaches方法中会创建并初始化MemoryRegionCache数组，其中tiny类型数组大小为32，small类型数组大小为4，normal类型数组大小为3：</p> <div class="language-java extra-class"><pre class="language-java"><code>#<span class="token class-name">PoolThreadCache</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">MemoryRegionCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">createSubPageCaches</span><span class="token punctuation">(</span>
        <span class="token keyword">int</span> cacheSize<span class="token punctuation">,</span> <span class="token keyword">int</span> numCaches<span class="token punctuation">,</span> <span class="token class-name">SizeClass</span> sizeClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheSize <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
        <span class="token class-name">MemoryRegionCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryRegionCache</span><span class="token punctuation">[</span>numCaches<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cache<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// TODO: maybe use cacheSize / cache.length</span>
            cache<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SubPageMemoryRegionCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>cacheSize<span class="token punctuation">,</span> sizeClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> cache<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最终会调用MemoryRegionCache构造方法进行创建，我们看下MemoryRegionCache结构：</p> <div class="language-java extra-class"><pre class="language-java"><code>#<span class="token class-name">PoolThreadCache</span>
<span class="token keyword">private</span> <span class="token keyword">abstract</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MemoryRegionCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  	<span class="token comment">// 队列大小，tiny类型size大小为512，small类型size大小为256，normal类型size大小为64</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span>
  	<span class="token comment">// 同种内存大小缓存队列</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">;</span>
  	<span class="token comment">// sizeClass分为三种：Tiny、Small、Normal</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SizeClass</span> sizeClass<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> allocations<span class="token punctuation">;</span>

    <span class="token class-name">MemoryRegionCache</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token class-name">SizeClass</span> sizeClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token class-name">MathUtil</span><span class="token punctuation">.</span><span class="token function">safeFindNextPositivePowerOfTwo</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        queue <span class="token operator">=</span> <span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token function">newFixedMpscQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sizeClass <span class="token operator">=</span> sizeClass<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>2.分配内存，首先会获取PooledByteBuf，然后进行内存分配：</p> <div class="language-java extra-class"><pre class="language-java"><code>#<span class="token class-name">PoolArena</span>
<span class="token class-name">PooledByteBuf</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token class-name">PoolThreadCache</span> cache<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> maxCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">PooledByteBuf</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> buf <span class="token operator">=</span> <span class="token function">newByteBuf</span><span class="token punctuation">(</span>maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">allocate</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> buf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>newByteBuf方法会尝试从对象池里面获取pooledByteBuf，如果没有则进行创建。allocate方法为内存分配核心逻辑，主要分为两种分配方式：page级别内存分配（8k~16M）、subPage级别内存分配（0~8K）、huge级别内存分配（&gt;16M）。page与subPage级别内存分配首先会尝试从缓存上进行内存分配，如果分配失败则重新申请内存。huge级别内存分配不会通过缓存进行分配。我们看下allocate方法主要流程：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token class-name">PoolThreadCache</span> cache<span class="token punctuation">,</span> <span class="token class-name">PooledByteBuf</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> buf<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">// 标准化容量，比如10B会标准化为16B，7K会标准化为8K</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> normCapacity <span class="token operator">=</span> <span class="token function">normalizeCapacity</span><span class="token punctuation">(</span>reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// tiny或者small类型内存分配</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTinyOrSmall</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// capacity &lt; pageSize</span>
        <span class="token keyword">int</span> tableIdx<span class="token punctuation">;</span>
        <span class="token class-name">PoolSubpage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> tiny <span class="token operator">=</span> <span class="token function">isTiny</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tiny<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// &lt; 512</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">allocateTiny</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// was able to allocate out of the cache so move on</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            tableIdx <span class="token operator">=</span> <span class="token function">tinyIdx</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            table <span class="token operator">=</span> tinySubpagePools<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">allocateSmall</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// was able to allocate out of the cache so move on</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            tableIdx <span class="token operator">=</span> <span class="token function">smallIdx</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            table <span class="token operator">=</span> smallSubpagePools<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token class-name">PoolSubpage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> head <span class="token operator">=</span> table<span class="token punctuation">[</span>tableIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * Synchronize on the head. This is needed as {@link PoolChunk#allocateSubpage(int)} and
         * {@link PoolChunk#free(long)} may modify the doubly linked list as well.
         */</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>head<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">PoolSubpage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> s <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> head<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">assert</span> s<span class="token punctuation">.</span>doNotDestroy <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">.</span>elemSize <span class="token operator">==</span> normCapacity<span class="token punctuation">;</span>
                <span class="token keyword">long</span> handle <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">assert</span> handle <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                s<span class="token punctuation">.</span>chunk<span class="token punctuation">.</span><span class="token function">initBufWithSubpage</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>tiny<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    allocationsTiny<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    allocationsSmall<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">allocateNormal</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  	<span class="token comment">// normal类型内存分配</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>normCapacity <span class="token operator">&lt;=</span> chunkSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">allocateNormal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// was able to allocate out of the cache so move on</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">allocateNormal</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      	<span class="token comment">// huge类型内存分配</span>
        <span class="token comment">// Huge allocations are never served via the cache so just call allocateHuge</span>
        <span class="token function">allocateHuge</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="subpage级别内存分配"><a href="#subpage级别内存分配" class="header-anchor">#</a> SubPage级别内存分配</h4> <p>首先尝试从缓存中进行分配：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">boolean</span> <span class="token function">allocateTiny</span><span class="token punctuation">(</span><span class="token class-name">PoolArena</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> area<span class="token punctuation">,</span> <span class="token class-name">PooledByteBuf</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token function">cacheForTiny</span><span class="token punctuation">(</span>area<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>cacheForTiney方法先根据分配内存大小定位到对应的tinySubPageDirectCaches数组中MemoryRegionCache，如果没有定位到则不能在缓存中进行分配。如果有则从MemoryRegionCache对应的队列中弹出一个PooledByteBuf对象进行初始化，同时为了复用PooledByteBuf对象，会将其缓存下来。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">MemoryRegionCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">cacheForTiny</span><span class="token punctuation">(</span><span class="token class-name">PoolArena</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> area<span class="token punctuation">,</span> <span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token class-name">PoolArena</span><span class="token punctuation">.</span><span class="token function">tinyIdx</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token keyword">if</span> <span class="token punctuation">(</span>area<span class="token punctuation">.</span><span class="token function">isDirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">return</span> <span class="token function">cache</span><span class="token punctuation">(</span>tinySubPageDirectCaches<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token punctuation">}</span>
  	<span class="token keyword">return</span> <span class="token function">cache</span><span class="token punctuation">(</span>tinySubPageHeapCaches<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token class-name">PooledByteBuf</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  	<span class="token comment">// 初始化PooledByteBuf</span>
    <span class="token function">initBuf</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>chunk<span class="token punctuation">,</span> entry<span class="token punctuation">.</span>handle<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 将PooledByteBuf对象放入栈中复用</span>
    entry<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// allocations is not thread-safe which is fine as this is only called from the same thread all time.</span>
    <span class="token operator">++</span> allocations<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果从缓存中分配不成功，则会从对应的PoolSubpage数组上进行分配，如果PoolSubpage数组对应的内存大小下标中有可分配空间则进行分配，并对PooledByteBuf进行初始化。</p> <p>如果在PoolSubpage数组上分配不成功，则表示没有可以用来分配的SubPage，则会尝试从Page上进行分配。先尝试从不同内存使用率的ChunkList进行分配，如果仍分配不成功，则表示没有可以用来分配的Chunk，此时会创建新的Chunk进行内存分配。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">allocateNormal</span><span class="token punctuation">(</span><span class="token class-name">PooledByteBuf</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">// 从不同内存使用率的ChunkList进行分配</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>q050<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span> q025<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span>
        q000<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span> qInit<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span> <span class="token operator">||</span>
        q075<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">++</span>allocationsNormal<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 创建一个新Chunk</span>
    <span class="token class-name">PoolChunk</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> <span class="token function">newChunk</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">,</span> maxOrder<span class="token punctuation">,</span> pageShifts<span class="token punctuation">,</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 分配内存</span>
    <span class="token keyword">long</span> handle <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">++</span>allocationsNormal<span class="token punctuation">;</span>
    <span class="token keyword">assert</span> handle <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
  	<span class="token comment">// 初始化PooledByteBuf</span>
    c<span class="token punctuation">.</span><span class="token function">initBuf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    qInit<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>进入PoolChunk#allocate方法看下分配流程：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">long</span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>normCapacity <span class="token operator">&amp;</span> subpageOverflowMask<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// &gt;= pageSize</span>
        <span class="token keyword">return</span> <span class="token function">allocateRun</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">allocateSubpage</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>allocateRun方法用来分配大于等于8K的内存，allocateSubpage用来分配小于8K的内存，进入allocateSubpage方法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">allocateSubpage</span><span class="token punctuation">(</span><span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Obtain the head of the PoolSubPage pool that is owned by the PoolArena and synchronize on it.</span>
    <span class="token comment">// This is need as we may add it back and so alter the linked-list structure.</span>
    <span class="token class-name">PoolSubpage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> head <span class="token operator">=</span> arena<span class="token punctuation">.</span><span class="token function">findSubpagePoolHead</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>head<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> d <span class="token operator">=</span> maxOrder<span class="token punctuation">;</span> <span class="token comment">// subpages are only be allocated from pages i.e., leaves</span>
      	<span class="token comment">// 找到Page</span>
        <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token function">allocateNode</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> id<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token class-name">PoolSubpage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> subpages <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subpages<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> pageSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageSize<span class="token punctuation">;</span>

        freeBytes <span class="token operator">-=</span> pageSize<span class="token punctuation">;</span>

        <span class="token keyword">int</span> subpageIdx <span class="token operator">=</span> <span class="token function">subpageIdx</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PoolSubpage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> subpage <span class="token operator">=</span> subpages<span class="token punctuation">[</span>subpageIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>subpage <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          	<span class="token comment">// 创建并初始化PoolSubpage</span>
            subpage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PoolSubpage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token function">runOffset</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            subpages<span class="token punctuation">[</span>subpageIdx<span class="token punctuation">]</span> <span class="token operator">=</span> subpage<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            subpage<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      	<span class="token comment">// 分配内存</span>
        <span class="token keyword">return</span> subpage<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>内存分配成功后会调用initBuf方法初始化PoolByteBuf：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">initBuf</span><span class="token punctuation">(</span><span class="token class-name">PooledByteBuf</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> buf<span class="token punctuation">,</span> <span class="token keyword">long</span> handle<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> memoryMapIdx <span class="token operator">=</span> <span class="token function">memoryMapIdx</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> bitmapIdx <span class="token operator">=</span> <span class="token function">bitmapIdx</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bitmapIdx <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">byte</span> val <span class="token operator">=</span> <span class="token function">value</span><span class="token punctuation">(</span>memoryMapIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> val <span class="token operator">==</span> unusable <span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        buf<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> handle<span class="token punctuation">,</span> <span class="token function">runOffset</span><span class="token punctuation">(</span>memoryMapIdx<span class="token punctuation">)</span><span class="token punctuation">,</span> reqCapacity<span class="token punctuation">,</span> <span class="token function">runLength</span><span class="token punctuation">(</span>memoryMapIdx<span class="token punctuation">)</span><span class="token punctuation">,</span>
                 arena<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">threadCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">initBufWithSubpage</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> bitmapIdx<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="page级别内存分配"><a href="#page级别内存分配" class="header-anchor">#</a> Page级别内存分配</h4> <p>Page级别内存分配和SubPage级别类似，同样是先从缓存中进行分配，分配不成功则尝试从不同内存使用率的ChunkList进行分配，如果仍分配不成功，则表示没有可以用来分配的Chunk，此时会创建新的Chunk进行内存分配，不同点在allocate方法中：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">allocateRun</span><span class="token punctuation">(</span><span class="token keyword">int</span> normCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> d <span class="token operator">=</span> maxOrder <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token function">log2</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span> <span class="token operator">-</span> pageShifts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 找到Page</span>
    <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token function">allocateNode</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    freeBytes <span class="token operator">-=</span> <span class="token function">runLength</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> id<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="huge级别内存分配"><a href="#huge级别内存分配" class="header-anchor">#</a> Huge级别内存分配</h4> <p>因为大于16M的内存分配Netty不会进行缓存，所以Huge级别内存分配会直接申请内存并进行初始化：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">allocateHuge</span><span class="token punctuation">(</span><span class="token class-name">PooledByteBuf</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">// 创建Chunk</span>
    <span class="token class-name">PoolChunk</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> chunk <span class="token operator">=</span> <span class="token function">newUnpooledChunk</span><span class="token punctuation">(</span>reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    activeBytesHuge<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span><span class="token function">chunkSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 初始化PoolByteBuf</span>
    buf<span class="token punctuation">.</span><span class="token function">initUnpooled</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    allocationsHuge<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="内存回收"><a href="#内存回收" class="header-anchor">#</a> 内存回收</h3> <p>调用ByteBuf#release方法会进行内存释放，方法中会判断当前byteBuf 是否被引用，如果没有被引用, 则调用deallocate方法进行释放：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">release0</span><span class="token punctuation">(</span><span class="token keyword">int</span> decrement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> refCnt <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>refCnt<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>refCnt <span class="token operator">&lt;</span> decrement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalReferenceCountException</span><span class="token punctuation">(</span>refCnt<span class="token punctuation">,</span> <span class="token operator">-</span>decrement<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>refCntUpdater<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> refCnt<span class="token punctuation">,</span> refCnt <span class="token operator">-</span> decrement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>refCnt <span class="token operator">==</span> decrement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              	<span class="token comment">// 释放内存</span>
                <span class="token function">deallocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>进入deallocate方法看下内存释放流程：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">deallocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> handle <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handle<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>handle <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        memory <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      	<span class="token comment">// 释放内存</span>
        chunk<span class="token punctuation">.</span>arena<span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> maxLength<span class="token punctuation">,</span> cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// 将PoolByteBuf对象加入到对象池</span>
        <span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>free方法会把释放的内存加入到缓存，如果加入缓存不成功则会标记这段内存为未使用：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token class-name">PoolChunk</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> chunk<span class="token punctuation">,</span> <span class="token keyword">long</span> handle<span class="token punctuation">,</span> <span class="token keyword">int</span> normCapacity<span class="token punctuation">,</span> <span class="token class-name">PoolThreadCache</span> cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">.</span>unpooled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> size <span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">chunkSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">destroyChunk</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        activeBytesHuge<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token operator">-</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        deallocationsHuge<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">SizeClass</span> sizeClass <span class="token operator">=</span> <span class="token function">sizeClass</span><span class="token punctuation">(</span>normCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// 加入到缓存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cache <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> cache<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> chunk<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> normCapacity<span class="token punctuation">,</span> sizeClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// cached so not free it.</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
				<span class="token comment">// 标记内存为未使用</span>
        <span class="token function">freeChunk</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> sizeClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>recycle方法会将PoolByteBuf对象放入到对象池中：</p> <div class="language-java extra-class"><pre class="language-java"><code>#<span class="token class-name">DefaultHandle</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recycle</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">!=</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;object does not belong to handle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/netty/netty_task.html" class="prev">Netty IO事件与任务处理</a></span> <span class="next"><a href="/netty/netty_write_and_flush.html">Netty writeAndFlush解析</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><div class="qrcode_container" data-v-5687ca4d><div class="tencent_code" data-v-5687ca4d><h4 data-v-5687ca4d>关注作者公众</h4> <p data-v-5687ca4d>和万千小伙伴一起学习</p> <img src="/ggh.jpg" alt data-v-5687ca4d></div> <div class="group_code" data-v-5687ca4d><h4 data-v-5687ca4d>加入技术交流群</h4> <p data-v-5687ca4d>扫描二维码 备注<span data-v-5687ca4d> 加群</span></p> <img src="/wechat.jpg" alt data-v-5687ca4d></div></div><!----></div></div>
    <script src="/assets/js/app.c279a524.js" defer></script><script src="/assets/js/2.0c1afcb6.js" defer></script><script src="/assets/js/6.c54a32fc.js" defer></script><script src="/assets/js/7.84ef9767.js" defer></script><script src="/assets/js/12.f1c48cfc.js" defer></script><script src="/assets/js/13.70bd7ce1.js" defer></script>
  </body>
</html>
